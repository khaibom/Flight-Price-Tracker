name: CI - Code Quality and Syntax Check

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  lint:
    name: Lint with Ruff (PEP8)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run Ruff linter
        run: |
          ruff check . --output-format=github

  syntax-check:
    name: Python Syntax Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Check Python syntax
        run: |
          # Find and compile all Python files in the repository
          find . -type f -name "*.py" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./.git/*" | while read -r file; do
            echo "Checking syntax: $file"
            python -m py_compile "$file"
          done

  import-check:
    name: Import and Compilation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create mock Secret.py for import testing
        run: |
          echo 'API_KEY = "test_key"' > Secret.py
          echo 'API_SECRET = "test_secret"' >> Secret.py
      
      - name: Test imports (compilation check)
        run: |
          # Find and test imports for all Python files in the repository
          find . -type f -name "*.py" -not -path "./.venv/*" -not -path "./venv/*" -not -path "./.git/*" -not -name "Secret.py" | while read -r file; do
            module=$(echo "$file" | sed 's|^\./||' | sed 's|\.py$||' | sed 's|/|.|g')
            echo "Testing import: $module (from $file)"
            python -c "import sys; sys.path.insert(0, '.'); exec(open('$file').read())" 2>&1 || echo "Note: $file may require specific runtime configuration"
          done
